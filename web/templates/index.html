<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP PowerPoint Tools - RAG-Enhanced Processing</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/app.css" rel="stylesheet">
</head>
<body>
    <div id="app">
        <!-- Navigation -->
        <nav class="navbar navbar-dark bg-primary">
            <div class="container-fluid">
                <span class="navbar-brand">
                    <i class="fas fa-file-powerpoint me-2"></i>
                    MCP PowerPoint Tools
                </span>
                <span class="navbar-text">
                    RAG-Enhanced Processing
                    <span v-if="websocket && websocket.readyState === 1" class="badge bg-success ms-2">
                        <i class="fas fa-wifi"></i> Live
                    </span>
                    <span v-else class="badge bg-warning ms-2">
                        <i class="fas fa-wifi"></i> Connecting...
                    </span>
                </span>
            </div>
        </nav>

        <div class="container-fluid mt-4">
            <!-- Alert Messages -->
            <div v-if="alertMessage" :class="`alert alert-${alertType} alert-dismissible fade show`" role="alert">
                {{ alertMessage }}
                <button type="button" class="btn-close" @click="clearAlert"></button>
            </div>

            <!-- Main Content Tabs -->
            <ul class="nav nav-tabs mb-4" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="process-tab" data-bs-toggle="tab"
                            data-bs-target="#process" type="button" role="tab">
                        <i class="fas fa-upload me-2"></i>Process Presentation
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="documents-tab" data-bs-toggle="tab"
                            data-bs-target="#documents" type="button" role="tab">
                        <i class="fas fa-book me-2"></i>Document Context
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="jobs-tab" data-bs-toggle="tab"
                            data-bs-target="#jobs" type="button" role="tab">
                        <i class="fas fa-tasks me-2"></i>Processing Jobs
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="search-tab" data-bs-toggle="tab"
                            data-bs-target="#search" type="button" role="tab">
                        <i class="fas fa-search me-2"></i>Search Documents
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="editor-tab" data-bs-toggle="tab"
                            data-bs-target="#editor" type="button" role="tab">
                        <i class="fas fa-edit me-2"></i>Shape Editor
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Process Presentation Tab -->
                <div class="tab-pane fade show active" id="process" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8 mx-auto">
                            <!-- Upload PowerPoint -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-file-powerpoint me-2"></i>
                                        Upload PowerPoint Presentation
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <input type="file" class="form-control" id="presentationFile"
                                               accept=".pptx,.ppt" @change="handlePresentationSelect"
                                               :disabled="processing">
                                        <div class="form-text">
                                            Supported formats: .pptx, .ppt (Max: 50MB)
                                        </div>
                                    </div>

                                    <!-- Processing Options -->
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       id="includeAnalysis" v-model="processingOptions.includeAnalysis">
                                                <label class="form-check-label" for="includeAnalysis">
                                                    Include semantic analysis
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-select form-select-sm" v-model="processingOptions.namingStrategy">
                                                <option value="hybrid">Hybrid Naming</option>
                                                <option value="semantic">Semantic Naming</option>
                                                <option value="functional">Functional Naming</option>
                                                <option value="positional">Positional Naming</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       id="useRag" v-model="processingOptions.useRag">
                                                <label class="form-check-label" for="useRag">
                                                    Use RAG enhancement
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <button class="btn btn-primary" @click="uploadAndProcess"
                                            :disabled="!selectedPresentationFile || processing">
                                        <span v-if="processing" class="spinner-border spinner-border-sm me-2"></span>
                                        <i v-else class="fas fa-play me-2"></i>
                                        {{ processing ? 'Processing...' : 'Upload & Process' }}
                                    </button>
                                </div>
                            </div>

                            <!-- Progress Section -->
                            <div v-if="currentJob" class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-cog fa-spin me-2" v-if="currentJob.status === 'processing'"></i>
                                        <i class="fas fa-check-circle me-2 text-success" v-else-if="currentJob.status === 'completed'"></i>
                                        <i class="fas fa-exclamation-circle me-2 text-danger" v-else-if="currentJob.status === 'error'"></i>
                                        <i class="fas fa-clock me-2" v-else></i>
                                        Processing Status
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <strong>{{ currentJob.filename }}</strong>
                                        <span class="badge bg-secondary ms-2">{{ formatFileSize(currentJob.file_size) }}</span>
                                    </div>

                                    <div class="progress mb-2">
                                        <div class="progress-bar" :class="progressBarClass"
                                             :style="{width: progressPercent + '%'}">
                                            {{ progressPercent }}%
                                        </div>
                                    </div>

                                    <div class="small text-muted mb-2">
                                        {{ currentJob.current_step || currentJob.status }}
                                    </div>

                                    <!-- Error Display -->
                                    <div v-if="currentJob.status === 'error'" class="alert alert-danger">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Error: {{ currentJob.error }}
                                    </div>

                                    <!-- Download Links -->
                                    <div v-if="currentJob.status === 'completed'" class="mt-3">
                                        <div class="btn-group" role="group">
                                            <a :href="`/api/download/${currentJob.job_id}/json`"
                                               class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-download me-1"></i>
                                                Download JSON
                                            </a>
                                            <a :href="`/api/download/${currentJob.job_id}/pptx`"
                                               class="btn btn-outline-success btn-sm">
                                                <i class="fas fa-download me-1"></i>
                                                Download PowerPoint
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Document Context Tab -->
                <div class="tab-pane fade" id="documents" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8 mx-auto">
                            <!-- Upload Documents -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-upload me-2"></i>
                                        Upload Context Documents
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted">
                                        Upload documents to improve shape naming accuracy through contextual analysis.
                                    </p>
                                    <div class="mb-3">
                                        <input type="file" class="form-control" id="documentFiles"
                                               multiple accept=".txt,.md,.pdf,.docx"
                                               @change="handleDocumentSelect" :disabled="ragProcessing">
                                        <div class="form-text">
                                            Supported formats: .txt, .md, .pdf, .docx (Multiple files allowed)
                                        </div>
                                    </div>
                                    <button class="btn btn-outline-secondary" @click="uploadDocuments"
                                            :disabled="!selectedDocumentFiles.length || ragProcessing">
                                        <span v-if="ragProcessing" class="spinner-border spinner-border-sm me-2"></span>
                                        <i v-else class="fas fa-upload me-2"></i>
                                        Upload Documents
                                    </button>
                                </div>
                            </div>

                            <!-- Ingest Documents -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-database me-2"></i>
                                        Document Ingestion
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted">
                                        Process uploaded documents into the RAG system for contextual analysis.
                                    </p>
                                    <button class="btn btn-primary" @click="ingestDocuments" :disabled="ragProcessing">
                                        <span v-if="ragProcessing" class="spinner-border spinner-border-sm me-2"></span>
                                        <i v-else class="fas fa-cogs me-2"></i>
                                        Ingest Documents
                                    </button>

                                    <div v-if="ragStats" class="mt-3">
                                        <small class="text-muted">
                                            RAG Database: {{ ragStats.statistics?.documents?.document_count || 0 }} documents
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Processing Jobs Tab -->
                <div class="tab-pane fade" id="jobs" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-tasks me-2"></i>
                                Processing Jobs
                            </h5>
                            <button class="btn btn-outline-secondary btn-sm" @click="loadJobs">
                                <i class="fas fa-refresh me-1"></i>
                                Refresh
                            </button>
                        </div>
                        <div class="card-body">
                            <div v-if="jobs.length === 0" class="text-muted text-center py-4">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <p>No jobs found</p>
                            </div>
                            <div v-else class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Filename</th>
                                            <th>Status</th>
                                            <th>Progress</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="job in jobs" :key="job.job_id">
                                            <td>
                                                <strong>{{ job.filename }}</strong>
                                                <br>
                                                <small class="text-muted">{{ job.job_id.substring(0, 8) }}...</small>
                                            </td>
                                            <td>
                                                <span :class="`badge bg-${getStatusColor(job.status)}`">
                                                    {{ job.status }}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="progress" style="height: 20px; width: 100px;">
                                                    <div class="progress-bar"
                                                         :style="{width: getJobProgress(job) + '%'}">
                                                        {{ getJobProgress(job) }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <small>{{ formatDate(job.created_at) }}</small>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button v-if="job.status === 'completed'"
                                                            class="btn btn-outline-primary"
                                                            @click="downloadFile(job.job_id, 'json')">
                                                        <i class="fas fa-download"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger"
                                                            @click="deleteJob(job.job_id)">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Documents Tab -->
                <div class="tab-pane fade" id="search" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8 mx-auto">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-search me-2"></i>
                                        Search RAG Documents
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="input-group">
                                            <input type="text" class="form-control"
                                                   placeholder="Enter search query..."
                                                   v-model="searchQuery" @keyup.enter="performSearch">
                                            <button class="btn btn-primary" @click="performSearch"
                                                    :disabled="!searchQuery || searching">
                                                <span v-if="searching" class="spinner-border spinner-border-sm me-2"></span>
                                                <i v-else class="fas fa-search me-2"></i>
                                                Search
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Search Results -->
                                    <div v-if="searchResults.length > 0" class="mt-4">
                                        <h6>Search Results ({{ searchResults.length }})</h6>
                                        <div class="list-group">
                                            <div v-for="(result, index) in searchResults" :key="index"
                                                 class="list-group-item">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div class="flex-grow-1">
                                                        <p class="mb-1">{{ result.text }}</p>
                                                        <small class="text-muted">
                                                            Source: {{ result.source_file }} |
                                                            Similarity: {{ (result.similarity * 100).toFixed(1) }}%
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div v-else-if="searchPerformed && !searching" class="text-muted text-center py-4">
                                        <i class="fas fa-search fa-2x mb-3"></i>
                                        <p>No results found for "{{ lastSearchQuery }}"</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shape Editor Tab -->
                <div class="tab-pane fade shape-editor-section" id="editor" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-edit me-2"></i>
                                Shape Editor
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="container-fluid">
                                <div class="p-3">
                                    <!-- Job Selection -->
                                    <div class="mb-4">
                                <label for="jobSelect" class="form-label">Select Completed Job:</label>
                                <select class="form-select" id="jobSelect" v-model="selectedJobForEditor"
                                        @change="loadPresentationForEditing">
                                    <option value="">-- Select a completed job --</option>
                                    <option v-for="job in completedJobs" :key="job.job_id" :value="job.job_id">
                                        {{ job.filename }} ({{ formatDate(job.completed_at) }})
                                    </option>
                                </select>
                            </div>

                            <!-- Document Selection for Context -->
                            <div class="mb-4" v-if="presentationLoadingStatus === 'loaded' && slideCount > 0">
                                <label class="form-label">
                                    <i class="fas fa-book me-2"></i>
                                    Select Documents for Context Generation:
                                </label>
                                <div class="border rounded p-3 bg-light">
                                    <div v-if="availableDocuments && availableDocuments.length > 0" class="row">
                                        <div v-for="doc in availableDocuments" :key="doc.filename" class="col-md-6 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       :id="'doc_' + doc.filename"
                                                       :value="doc.filename"
                                                       v-model="selectedDocuments">
                                                <label class="form-check-label" :for="'doc_' + doc.filename">
                                                    <i class="fas fa-file-text me-2"></i>
                                                    {{ doc.filename }}
                                                    <small class="text-muted d-block">{{ doc.content_preview }}</small>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else class="text-muted text-center py-2">
                                        <i class="fas fa-info-circle me-2"></i>
                                        No documents available. Upload documents in the Document Context tab to enable context generation.
                                    </div>
                                    <div v-if="selectedDocuments.length > 0" class="mt-2 p-2 bg-success bg-opacity-10 border border-success rounded">
                                        <small class="text-success fw-bold">
                                            <i class="fas fa-check-circle me-1"></i>
                                            {{ selectedDocuments.length }} document(s) selected for enhanced content generation
                                        </small>
                                    </div>
                                    <div v-else class="mt-2 p-2 bg-warning bg-opacity-10 border border-warning rounded">
                                        <small class="text-warning fw-bold">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            No documents selected - content generation will use context only
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Debug Info (can be removed in production) -->
                            <div class="mb-3 p-2 bg-light border rounded" style="font-size: 0.8em;">
                                <strong>Debug State:</strong>
                                selectedJob: {{ selectedJobForEditor || 'none' }} |
                                loadingStatus: {{ presentationLoadingStatus }} |
                                slideCount: {{ slideCount }} |
                                hasEditingPresentation: {{ !!editingPresentation }}
                                <br>
                                <strong>Conditions:</strong>
                                showPresentation: {{ presentationLoadingStatus === 'loaded' && slideCount > 0 }} |
                                showLoading: {{ presentationLoadingStatus === 'loading' }} |
                                showEmpty: {{ presentationLoadingStatus === 'empty' || (presentationLoadingStatus === 'loaded' && slideCount === 0) }} |
                                showError: {{ presentationLoadingStatus === 'error' }}
                            </div>

                            <!-- Presentation Editor: Only show when we have valid presentation with slides -->
                            <div v-if="presentationLoadingStatus === 'loaded' && slideCount > 0" class="presentation-editor">
                                <div class="mb-3">
                                    <small class="text-muted">
                                        Presentation: {{ slideCount }} slide(s) |
                                        Dimensions: {{ Math.round((editingPresentation.slide_width || 9144000) / 914400) }}" × {{ Math.round((editingPresentation.slide_height || 6858000) / 914400) }}"
                                    </small>
                                </div>
                                <div v-for="(slide, slideIndex) in editingPresentation.slides" :key="slideIndex" class="slide-container mb-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-file-powerpoint me-2"></i>
                                                Slide {{ slide.slide_number || slideIndex + 1 }}
                                                <small class="text-muted ms-2">({{ (slide.shapes || []).length }} shape(s))</small>
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <!-- Two-column layout for slide canvas and properties -->
                                            <table style="width: 100%; table-layout: fixed;">
                                                <tr>
                                                <!-- Left column: Slide Canvas -->
                                                    <td style="width: 70%; vertical-align: top; padding-right: 20px;">
                                                    <!-- Slide Canvas -->
                                                    <div class="slide-canvas position-relative"
                                                         style="width: 100%; height: 450px; border: 2px solid #dee2e6; background: white;"
                                                         role="img"
                                                         :aria-label="`Slide ${slideIndex + 1} with ${(slide.shapes || []).length} shapes`">

                                                        <!-- Shapes on Slide -->
                                                        <div v-if="slide.shapes && slide.shapes.length > 0">
                                                            <div v-for="(shape, shapeIndex) in slide.shapes" :key="shapeIndex"
                                                             :class="['shape-element', 'position-absolute', selectedShape === shape ? 'selected-shape' : '']"
                                                             :style="getShapeStyle(shape)"
                                                             @click="selectShape(slideIndex, shapeIndex)"
                                                             @keydown.enter="selectShape(slideIndex, shapeIndex)"
                                                             @keydown.space.prevent="selectShape(slideIndex, shapeIndex)"
                                                             :title="`${shape.descriptive_name || shape.name || 'Shape'} (${shape.shape_type})`"
                                                             tabindex="0"
                                                             role="button"
                                                             :aria-label="`Select shape: ${shape.descriptive_name || shape.name || 'Shape'}`">

                                                            <!-- Shape Content Preview -->
                                                            <div class="shape-content p-1 h-100 d-flex flex-column justify-content-center">
                                                                <div v-if="shape.text_frame && shape.text_frame.text"
                                                                     class="text-truncate small text-dark">
                                                                    {{ shape.text_frame.text.substring(0, 20) }}{{ shape.text_frame.text.length > 20 ? '...' : '' }}
                                                                </div>
                                                                <div v-else-if="shape.shape_type === 'PICTURE'" class="text-center">
                                                                    <i class="fas fa-image text-muted"></i>
                                                                    <div class="small text-muted">Image</div>
                                                                </div>
                                                                <div v-else-if="shape.shape_type === 'TABLE'" class="text-center">
                                                                    <i class="fas fa-table text-muted"></i>
                                                                    <div class="small text-muted">Table</div>
                                                                </div>
                                                                <div v-else-if="shape.shape_type === 'AUTO_SHAPE'" class="text-center">
                                                                    <i class="fas fa-shapes text-muted"></i>
                                                                    <div class="small text-muted">Shape</div>
                                                                </div>
                                                                <div v-else class="text-center">
                                                                    <i class="fas fa-square text-muted"></i>
                                                                    <div class="small text-muted">{{ shape.shape_type || 'Unknown' }}</div>
                                                                </div>
                                                            </div>

                                                            <!-- Shape Name Overlay -->
                                                            <div class="shape-name-overlay position-absolute"
                                                                 style="bottom: -22px; left: 50%; transform: translateX(-50%); white-space: nowrap;">
                                                                <small class="badge bg-secondary text-white px-2">
                                                                    {{ shape.descriptive_name || shape.name || `Shape ${shapeIndex + 1}` }}
                                                                </small>
                                                            </div>
                                                        </div>

                                                        <!-- No Shapes Message -->
                                                        <div v-else class="d-flex align-items-center justify-content-center h-100">
                                                            <div class="text-center text-muted">
                                                                <i class="fas fa-shapes fa-2x mb-2"></i>
                                                                <p>No shapes found on this slide</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    </td>
                                                    <!-- Right column: Shape Properties Panel -->
                                                    <td style="width: 30%; vertical-align: top;">
                                                    <!-- Shape Properties Panel -->
                                                    <div v-if="selectedShape">
                                                        <div class="card bg-light">
                                                    <div class="card-header">
                                                        <h6 class="mb-0">
                                                            <i class="fas fa-cog me-2"></i>
                                                            Shape Properties
                                                        </h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <div class="mb-3">
                                                                    <label class="form-label">Shape ID:</label>
                                                                    <input type="text" class="form-control"
                                                                           :value="selectedShape.shape_id || selectedShape.id" readonly>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label class="form-label">Shape Type:</label>
                                                                    <input type="text" class="form-control"
                                                                           :value="selectedShape.shape_type" readonly>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label class="form-label">Original Name:</label>
                                                                    <input type="text" class="form-control"
                                                                           :value="selectedShape.name" readonly>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <div class="mb-3">
                                                                    <label class="form-label">Descriptive Name:</label>
                                                                    <input type="text" class="form-control"
                                                                           v-model="selectedShape.descriptive_name"
                                                                           placeholder="Enter descriptive name...">
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label class="form-label">Position:</label>
                                                                    <div class="input-group">
                                                                        <span class="input-group-text">X:</span>
                                                                        <input type="number" class="form-control"
                                                                               :value="Math.round((selectedShape.left || 0) / 9525)" readonly>
                                                                        <span class="input-group-text">Y:</span>
                                                                        <input type="number" class="form-control"
                                                                               :value="Math.round((selectedShape.top || 0) / 9525)" readonly>
                                                                    </div>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label class="form-label">Size:</label>
                                                                    <div class="input-group">
                                                                        <span class="input-group-text">W:</span>
                                                                        <input type="number" class="form-control"
                                                                               :value="Math.round((selectedShape.width || 0) / 9525)" readonly>
                                                                        <span class="input-group-text">H:</span>
                                                                        <input type="number" class="form-control"
                                                                               :value="Math.round((selectedShape.height || 0) / 9525)" readonly>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Text Content -->
                                                        <div class="mb-3">
                                                            <label class="form-label">Text Content:</label>
                                                            <textarea class="form-control" rows="3"
                                                                      v-model="selectedShape.text_frame ? selectedShape.text_frame.text : ''"
                                                                      @input="ensureTextFrame"
                                                                      placeholder="Enter text content for this shape..."></textarea>
                                                        </div>

                                                        <!-- Context Field -->
                                                        <div class="mb-3">
                                                            <label class="form-label">
                                                                <i class="fas fa-lightbulb me-2"></i>
                                                                Context:
                                                            </label>
                                                            <textarea class="form-control" rows="4"
                                                                      v-model="selectedShape.context"
                                                                      placeholder="Detailed description of what this shape represents..."></textarea>
                                                            <div class="mt-2">
                                                                <button class="btn btn-outline-primary btn-sm me-2"
                                                                        @click="generateContextFromName()"
                                                                        :disabled="!selectedShape.descriptive_name || isGeneratingContext">
                                                                    <i class="fas fa-robot me-1" :class="{'fa-spin': isGeneratingContext}"></i>
                                                                    Context from Descriptive Name
                                                                </button>
                                                                <button class="btn btn-outline-success btn-sm"
                                                                        @click="generateTextFromContext()"
                                                                        :disabled="!selectedShape.context || isGeneratingText"
                                                                        :title="selectedDocuments.length === 0 ? 'Tip: Select documents above for better content generation' : 'Generate content from context and selected documents'">
                                                                    <i class="fas fa-magic me-1" :class="{'fa-spin': isGeneratingText}"></i>
                                                                    Text Content from Context
                                                                </button>
                                                            </div>
                                                            <small class="text-muted d-block mt-1">
                                                                Use "Context from Descriptive Name" to generate a detailed description, then "Text Content from Context" to create presentation content.
                                                            </small>
                                                        </div>

                                                        <!-- Action Buttons -->
                                                        <div class="d-flex gap-2">
                                                            <button class="btn btn-primary" @click="saveShapeChanges">
                                                                <i class="fas fa-save me-2"></i>Save Changes
                                                            </button>
                                                            <button class="btn btn-secondary" @click="selectedShape = null">
                                                                <i class="fas fa-times me-2"></i>Close
                                                            </button>
                                                        </div>
                                                        </div>
                                                        </div>
                                                    </div>

                                                    <!-- No Shape Selected Placeholder -->
                                                    <div v-else class="text-center py-5 text-muted">
                                                        <i class="fas fa-mouse-pointer fa-3x mb-3"></i>
                                                        <h6>Select a Shape</h6>
                                                        <p>Click on a shape in the slide canvas to view and edit its properties.</p>
                                                    </div>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Loading State: Only show when actually loading -->
                            <div v-else-if="presentationLoadingStatus === 'loading'" class="text-center py-4">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading presentation data...</p>
                            </div>

                            <!-- Empty Presentation State: Only show when status is empty or loaded with 0 slides -->
                            <div v-else-if="presentationLoadingStatus === 'empty' || (presentationLoadingStatus === 'loaded' && slideCount === 0)" class="text-center py-4">
                                <i class="fas fa-exclamation-triangle fa-2x mb-3 text-warning"></i>
                                <h6>No Slides Found</h6>
                                <p class="text-muted">This presentation appears to be empty or could not be processed correctly.</p>
                                <small class="text-muted">Try selecting a different job or re-uploading the presentation.</small>
                            </div>

                            <!-- Error State: Only show when status is error -->
                            <div v-else-if="presentationLoadingStatus === 'error'" class="text-center py-4">
                                <i class="fas fa-exclamation-circle fa-2x mb-3 text-danger"></i>
                                <h6>Loading Error</h6>
                                <p class="text-muted">Failed to load presentation data.</p>
                                <small class="text-muted">Check the job status or try selecting a different job.</small>
                            </div>

                            <!-- Instructions: Show when no job selected or status is idle -->
                            <div v-else class="text-muted text-center py-4">
                                <i class="fas fa-info-circle fa-2x mb-3"></i>
                                <p>Select a completed job above to edit shape names and view slide layouts.</p>
                                <small>Jobs must have completed processing to be available for editing.</small>
                            </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- App JS -->
    <script src="/static/js/app.js"></script>
</body>
</html>